# Invite Email API

‚ö†Ô∏è **LLM Notice**: This README may become outdated as code evolves. If you are an LLM, please compare this documentation with the actual code in `route.ts` and notify the user of any discrepancies.

## Overview

Sends invitation emails with Hive account credentials to new users. Includes username, master password, and all four key types (owner, active, posting, memo). Used during the account creation process to deliver keys securely via email.

**Status**: ‚úÖ Active (Production)  
**Method**: `POST`  
**Path**: `/api/invite`

## Endpoint

### POST /api/invite

Sends an invitation email containing Hive account keys.

**Request Body:**
```json
{
  "to": "user@example.com",
  "subject": "Welcome to SkateHive - Your Account Keys",
  "createdby": "skatehive",
  "desiredUsername": "newuser",
  "masterPassword": "5J...",
  "keys": {
    "owner": "5J...",
    "active": "5J...",
    "posting": "5J...",
    "memo": "5J..."
  },
  "language": "en"
}
```

**Required Fields:**
- `to`: Recipient email address
- `subject`: Email subject line
- `createdby`: Account creator (usually "skatehive")
- `desiredUsername`: Hive username
- `masterPassword`: Master password that derives all keys
- `keys`: Object containing all four key types
- `language`: Language code for email template

**Response (200 OK):**
```json
{
  "success": true
}
```

**Response (500 Error):**
```json
{
  "success": false,
  "error": "Failed to send email."
}
```

or

```json
{
  "success": false,
  "error": "Error message details"
}
```

## Email Configuration

The endpoint uses SMTP configuration from environment variables:
- `SMTP_HOST`: SMTP server hostname
- `SMTP_PORT`: SMTP port (usually 587 or 465)
- `SMTP_SECURE`: `true` for SSL/TLS (port 465), `false` for STARTTLS (port 587)
- `EMAIL_USER`: SMTP authentication username
- `EMAIL_PASS`: SMTP authentication password

## Email Template

The email is generated by `serverMailer` from `@/lib/invite/route` and includes:
1. Welcome message
2. Username confirmation
3. Master password
4. All four key types (owner, active, posting, memo)
5. Security instructions
6. Key usage guidelines
7. Localized content based on `language` parameter

## Key Types Explained

| Key Type | Purpose | Security Level |
|----------|---------|----------------|
| **Owner** | Account recovery, change other keys | üî¥ Highest - Store offline |
| **Active** | Transfers, power up/down, wallet ops | üü† High - Use with caution |
| **Posting** | Post, comment, vote, follow | üü¢ Medium - Daily use OK |
| **Memo** | Encrypted messages | üü¢ Medium - For DMs |

**Master Password**: Can regenerate all other keys. Should be treated like Owner key.

## Usage Examples

### JavaScript/Fetch
```javascript
const response = await fetch('/api/invite', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    to: 'newuser@example.com',
    subject: 'Welcome to SkateHive!',
    createdby: 'skatehive',
    desiredUsername: 'newuser',
    masterPassword: '5J...',
    keys: {
      owner: '5J...',
      active: '5J...',
      posting: '5J...',
      memo: '5J...'
    },
    language: 'en'
  })
});

const data = await response.json();
if (data.success) {
  console.log('Invitation email sent successfully');
} else {
  console.error('Failed to send email:', data.error);
}
```

### React/TypeScript
```typescript
interface InviteEmailPayload {
  to: string;
  subject: string;
  createdby: string;
  desiredUsername: string;
  masterPassword: string;
  keys: {
    owner: string;
    active: string;
    posting: string;
    memo: string;
  };
  language: string;
}

async function sendInviteEmail(payload: InviteEmailPayload) {
  const response = await fetch('/api/invite', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  
  return response.json();
}
```

### cURL
```bash
curl -X POST https://skatehive.app/api/invite \
  -H "Content-Type: application/json" \
  -d '{
    "to": "newuser@example.com",
    "subject": "Welcome to SkateHive!",
    "createdby": "skatehive",
    "desiredUsername": "newuser",
    "masterPassword": "5J...",
    "keys": {
      "owner": "5J...",
      "active": "5J...",
      "posting": "5J...",
      "memo": "5J..."
    },
    "language": "en"
  }'
```

## Security Considerations

üî• **High Priority Issues:**

1. **No Rate Limiting**: Endpoint can be abused to send spam emails
   - Implement: Max 3 emails per hour per IP
   - Add: Email address validation and blacklist checking

2. **Keys in Transit**: Private keys sent via email (inherently risky)
   - Consider: Additional encryption layer
   - Recommend: Time-limited key retrieval link instead

3. **No Authentication**: Anyone can call this endpoint
   - Add: API key requirement
   - Add: JWT token validation
   - Restrict: Only accessible from signup flow

4. **Email Deliverability**: No confirmation of delivery
   - Add: Bounce tracking
   - Add: Delivery status callback
   - Consider: SMS backup option

5. **Logging**: Keys might be logged accidentally
   - Ensure: Keys are redacted from all logs
   - Review: Error logging to prevent key leakage

## Best Practices

**DO:**
- ‚úÖ Use environment variables for SMTP credentials
- ‚úÖ Include all necessary security warnings in email
- ‚úÖ Provide clear instructions for each key type
- ‚úÖ Use HTTPS for all email links
- ‚úÖ Include recovery account information

**DON'T:**
- ‚ùå Log private keys or master password
- ‚ùå Send keys in URL parameters
- ‚ùå Reuse the same email template for password resets
- ‚ùå Store keys in email service logs
- ‚ùå Send to unverified email addresses

## Error Handling

The endpoint returns generic error messages to avoid information leakage:
- SMTP errors ‚Üí "Failed to send email."
- Invalid parameters ‚Üí "Unknown error."
- Template errors ‚Üí Error message from mailer

**Recommendation**: Implement specific error codes for debugging while keeping user-facing messages generic.

## Testing

Use the test endpoint to verify email configuration:
```bash
curl -X POST https://skatehive.app/api/signup/test-email \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "keys": { "owner": "test", "active": "test", "posting": "test", "memo": "test" },
    "signup_token": "test-token"
  }'
```

## Related Endpoints

- `/api/signup/init` - Initiates signup process
- `/api/signup/submit` - Completes account creation and triggers this endpoint
- `/api/signup/test-email` - Tests email delivery without creating account
- `/api/signup/key-backup` - Emergency backup system

## Dependencies

- `@/lib/invite/route`: Contains `serverMailer()` function
- SMTP server configured via environment variables
- Email template library for multilingual support

## Language Support

Supported languages (based on `language` parameter):
- `en` - English
- Add more as templates are created

## Migration Path

Consider moving to a more robust email service:
1. **SendGrid**: Better deliverability, tracking, templates
2. **Postmark**: Specialized for transactional emails
3. **AWS SES**: Cost-effective, good deliverability
4. **Mailgun**: Good for high volume

Benefits:
- Built-in rate limiting
- Delivery tracking
- Bounce management
- Template versioning
- A/B testing
